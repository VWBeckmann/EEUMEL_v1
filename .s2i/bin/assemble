#!/bin/bash
set -e

echo "Checking for requirements.txt..."
if [ ! -f "/tmp/src/requirements.txt" ]; then
  echo "Error: requirements.txt not found!"
  exit 1
fi

echo "Upgrading pip and setuptools..."
pip install --no-cache-dir --upgrade pip setuptools

# Install dependencies in smaller batches to reduce memory usage
TOTAL_DEPENDENCIES=$(wc -l < /tmp/src/requirements.txt)
BATCH_SIZE=1

# Iterate over the lines in the requirements.txt file in batches
for ((i=1; i<=TOTAL_DEPENDENCIES; i+=BATCH_SIZE)); do
    END_INDEX=$((i + BATCH_SIZE - 1))
    if [ $END_INDEX -gt $TOTAL_DEPENDENCIES ]; then
        END_INDEX=$TOTAL_DEPENDENCIES
    fi
    
    echo "Installing batch from line $i to $END_INDEX..."
    # Extract the batch
    sed -n "${i},${END_INDEX}p" /tmp/src/requirements.txt > /tmp/src/batch.txt

    # Log the batch content for debugging
    cat /tmp/src/batch.txt

    # Install the current batch one by one, without dependencies (no recursion)
    while read -r package; do
        echo "Installing $package..."
        pip install --no-cache-dir --disable-pip-version-check -r "$package"
    done < /tmp/src/batch.txt
done

echo "Dependencies installed successfully."
