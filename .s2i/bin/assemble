#!/bin/bash
set -e

# Check if requirements.txt exists
if [ ! -f "/tmp/src/requirements.txt" ]; then
  echo "Error: requirements.txt not found in /tmp/src/"
  ls -l /tmp/src/  # List files for debugging
  exit 1
fi

# Create an empty list for all the packages to install
install_list=()

# Read each package from the requirements.txt file
while IFS= read -r package; do
    # Skip empty lines or comments
    if [[ -z "$package" || "$package" =~ ^# ]]; then
        continue
    fi

    echo "Getting dependencies for $package..."

    # Get the list of recursively required packages using pipdeptree
    # This will list all dependencies including transitive ones
    deps=$(pipdeptree --freeze --warn silence | grep "$package==" | awk -F '==' '{print $1}' | sort | uniq)

    # Add the package itself and its dependencies to the install list
    for dep in $deps; do
        if [[ ! " ${install_list[@]} " =~ " ${dep} " ]]; then
            install_list+=("$dep")
        fi
    done
done < "requirements.txt"

# Log the final list of packages to install
echo "Installing the following packages one by one:"
for dep in "${install_list[@]}"; do
    echo "$dep"
done

# Install each package one by one
for dep in "${install_list[@]}"; do
    echo "Installing $dep..."
    pip install --no-cache-dir --disable-pip-version-check "$dep"
done

echo "All packages installed successfully."
